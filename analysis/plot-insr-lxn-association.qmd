---
title: "Analysis of association between Insr and Lxn expression across different individual hypothalamic nuclei astrocytes evaluation datasets"
author: "Evgenii O. Tretiakov"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    df-print: paged
    code-fold: true
    fig-width: 9
    fig-height: 12
    fig-format: retina
    fig-responsive: true
    fig-dpi: 200
execute:
  keep-md: false
  echo: true
  error: false
  message: false
  warning: false
  debug: false
knitr:
  opts_chunk:
    autodep: true
    fig.align: center
    fig.retina: 2
    fig.width: 14
    fig.height: 12
---

```{r setup, include = FALSE}
DOCNAME <- "plot-insr-lxn-association-astrocytes-between-regions-on-evaluation-datasets"
NOW <- Sys.time()

# Time chunks during knitting
knitr::knit_hooks$set(timeit = function(before) {
  if (before) {
    print(paste("Start:", Sys.time()))
    NOW <<- Sys.time()
  } else {
    print(paste("Stop:", Sys.time()))
    print(Sys.time() - NOW)
  }
})

knitr::knit_hooks$set(debug = function(before, options, envir) {
  if (!before) {
    message(
      paste(names(envir), as.list(envir),
        sep = " = ", collapse = "\n"
      )
    )
  }
})

knitr::opts_chunk$set(
  cache          = FALSE,
  dev            = c("png", "pdf"),
  timeit         = TRUE
)
```

## Load data and setup parameters

```{r libraries, cache=FALSE}
# Load tidyverse infrastructure packages
suppressPackageStartupMessages({
  library(future)
  library(here)
  library(tidyverse)
  library(magrittr)
  library(stringr)
  library(skimr)
  library(RColorBrewer)
  library(viridis)
})


# Load packages for scRNA-seq analysis and visualisation
suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
  library(patchwork)
  library(ggstatsplot)
  library(sceasy)
  library(Seurat)
  library(SeuratDisk)
  library(SeuratWrappers)
  library(schex)
  library(scCustomize)
})
```

### Set paths

```{r paths}
src_dir <- here("code/")
data_dir <- here("data/")
output_dir <- here("output")
plots_dir <- here(output_dir, "figures/")
tables_dir <- here(output_dir, "tables/")
```

### Load helper functions and gene-sets

```{r source, cache = FALSE}
source(here(src_dir, "genes.R"))
source(here(src_dir, "functions.R"))
```

### Set fixed variables

```{r params-computation, cache = FALSE}
# set seed
reseed <- 42
set.seed(seed = reseed)

# Parameters for parallel execution
n_cores <- 8
plan("multisession", workers = n_cores)
options(
  future.globals.maxSize = 1999999 * 1024^2,
  future.rng.onMisuse = "ignore"
)
plan()


# ggplot2 theme
theme_set(ggmin::theme_powerpoint())
```

```{r params}
bioproject <- "individual_hypothalamic_nuclei_astrocytes_evaluation_dataset"
cb_fpr <- 0.001
connectivity_model <- "min_tree"
k <- 10
metric <- "euclidean"
signature <- 100
```

## Load predicted astrocytes data

```{r load-seurat}
srt_path <- here(
  data_dir,
  sprintf("best_xgboost-subregional-astrocytes_dataset-msp_%s-metric_%s-k_%s-sign_%s-amb_%s.h5Seurat", connectivity_model, metric, k, signature, cb_fpr)
)
srt <- LoadH5Seurat(file = srt_path)

srt <-
  Store_Palette_Seurat(
    seurat_object = srt,
    palette = c(
      "#ffff00", "#fae200", "#f4c500", "#eeab00", "#e99500",
      "#e37f00", "#dd6b00", "#d75b00", "#d04c00", "#c93e00",
      "#c33300", "#bc2800", "#b42003", "#ad1941", "#a41281",
      "#9c0db7", "#9309dd", "#8906f7", "#7f04ff", "#7402f6",
      "#6701db", "#5900b0", "#49007e", "#32003e", "#000000"
    ),
    palette_name = "expr_Colour_Palette_gnuplot_rette_gnuplot_r")

srt <-
  Store_Palette_Seurat(
    seurat_object = srt,
    palette = rev(brewer.pal(n = 11, name = "Spectral")),
    palette_name = "div_Colour_Pal"
  )

colours_code <- c(
  "0" = "grey30",
  "1" = "blue",
  "2" = "skyblue",
  "3" = "forestgreen",
  "4" = "greenyellow",
  "5" = "yellow",
  "6" = "orangered",
  "7" = "grey70"
)

colours_region <- c(
  "ARC" = "grey30",
  "LHA" = "blue",
  "MnPO" = "skyblue",
  "POA" = "forestgreen",
  "PVN" = "greenyellow",
  "SCN" = "yellow",
  "VMH" = "orangered",
  "VPH" = "grey70"
)

coded_region <- c(
  "0" = "ARC" ,
  "1" = "LHA" ,
  "2" = "MnPO",
  "3" = "POA" ,
  "4" = "PVN" ,
  "5" = "SCN" ,
  "6" = "VMH" ,
  "7" = "VPH"
)

print(srt)
invisible(gc())
```

## Preprocess data

```{r scale-data}
srt <- NormalizeData(srt)
srt <- FindVariableFeatures(srt, selection.method = "vst", nfeatures = 5000)
all.genes <- rownames(srt)
srt <- ScaleData(srt, features = all.genes)
```


## Plot joint kernel density distributions (default):

### Insr and Lxn expression in astrocytes

```{r plot-density-insr-lxn}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Insr", "Lxn"))
```

### Gfap and Lxn expression in astrocytes

```{r plot-density-gfap-lxn}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Gfap", "Lxn"))
```

### Insr and Gfap expression in astrocytes

```{r plot-density-insr-gfap}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Insr", "Gfap"))
```

### Gfap and Mfn2 expression in astrocytes

```{r plot-density-gfap-mfn2}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Gfap", "Mfn2"))
```

### Mfn2 and Lxn expression in astrocytes

```{r plot-density-lxn-mfn2}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Lxn", "Mfn2"))
```

## Plot joint kernel density distributions (spectral):

### Insr and Lxn expression in astrocytes

```{r plot-density-insr-lxn-spectral}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Insr", "Lxn"), custom_palette = srt@misc$div_Colour_Pal)
```

### Gfap and Lxn expression in astrocytes

```{r plot-density-gfap-lxn-spectral}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Gfap", "Lxn"), custom_palette = srt@misc$div_Colour_Pal)
```

### Insr and Gfap expression in astrocytes

```{r plot-density-insr-gfap-spectral}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Insr", "Gfap"), custom_palette = srt@misc$div_Colour_Pal)
```

### Gfap and Mfn2 expression in astrocytes

```{r plot-density-gfap-mfn2-spectral}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Gfap", "Mfn2"), custom_palette = srt@misc$div_Colour_Pal)
```

### Mfn2 and Lxn expression in astrocytes

```{r plot-density-lxn-mfn2-spectral}
Plot_Density_Joint_Only(seurat_object = srt, reduction = "densmap_xgboost", features = c("Lxn", "Mfn2"), custom_palette = srt@misc$div_Colour_Pal)
```

## Calculate and plot chi2 test of independence between Insr and Lxn expression in astrocytes across different individual hypothalamic nuclei

```{r plot-chi2, fig.width=8, fig.height=24}
sbs_mtx <- GetAssayData(object = srt, slot = "count", assay = "RNA") %>%
  as.data.frame() %>%
  t() %>%
  as.data.frame() %>%
  select(Insr, Lxn) %>%
  dplyr::bind_cols(srt@meta.data) %>%
  select(region, Insr, Lxn) %>%
  mutate(Insr_pos = Insr > 0,
         Lxn_pos  = Lxn  > 0)

sbs_mtx %>% skimr::skim()

write_csv(sbs_mtx, here(tables_dir, "insr-lxn-association-astrocytes-between-regions-on-evaluation-datasets.csv"))


# plot
grouped_ggpiestats(
  # arguments relevant for `ggpiestats()`
  data = sbs_mtx,
  x = Insr_pos,
  y = Lxn_pos,
  grouping.var = region,
  perc.k = 1,
  package = "ggsci",
  palette = "category10_d3",
  # arguments relevant for `combine_plots()`
  title.text = "InsR specification of Lxn-positive hypothalamic astrocytic lineages",
  caption.text = "Asterisks denote results from proportion tests; \n***: p < 0.001, ns: non-significant",
  plotgrid.args = list(nrow = 8)
)

grouped_ggpiestats(
  # arguments relevant for `ggpiestats()`
  data = sbs_mtx,
  x = Lxn_pos,
  y = Insr_pos,
  grouping.var = region,
  perc.k = 1,
  package = "ggsci",
  palette = "category10_d3",
  # arguments relevant for `combine_plots()`
  title.text = "InsR specification of Lxn-positive hypothalamic astrocytic lineages",
  caption.text = "Asterisks denote results from proportion tests; \n***: p < 0.001, ns: non-significant",
  plotgrid.args = list(nrow = 8)
)
```

## Calculate and plot hexagonal cells representation of astrocytes across different individual hypothalamic nuclei with meta information

```{r plot-hexbin}
srt <- make_hexbin(
  srt,
  nbins = 25,
  dimension_reduction = "densmap_xgboost",
  use_dims = c(1, 2)
)

plot_hexbin_density(srt) + ggsci::scale_fill_material("amber")


plot_hexbin_meta(
  srt,
  col = "project",
  action = "majority"
)

plot_hexbin_meta(
  srt,
  col = "orig.ident",
  action = "majority"
)

plot_hexbin_meta(
  srt,
  col = "tech",
  action = "majority"
)

plot_hexbin_meta(
  srt,
  col = "sex",
  action = "majority"
)

plot_hexbin_meta(
  srt,
  col = "stage",
  action = "majority"
)

plot_hexbin_meta(
  srt,
  col = "predictions_xgboost_eval",
  action = "majority",
  colors = colours_code
)

plot_hexbin_meta(
  srt,
  col = "region",
  action = "majority",
  colors = colours_region
)
```

## Quantify and plot hexagon representation of feature interactions with Spearman's correlation

### Insr and Lxn correlation in astrocytes

```{r calc-hexagon-representation-spearman-insr-lxn}
p1 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Insr", "Lxn"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Insr and Lxn/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p1
```

### Insr and Gfap correlation in astrocytes

```{r calc-hexagon-representation-spearman-insr-gfap}
p2 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Insr", "Gfap"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Insr and Gfap/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p2
```

### Insr and Mfn2 correlation in astrocytes

```{r calc-hexagon-representation-spearman-insr-mfn2}
p3 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Insr", "Mfn2"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Insr and Mfn2/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p3
```

### Lxn and Gfap correlation in astrocytes

```{r calc-hexagon-representation-spearman-lxn-gfap}
p4 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Lxn", "Gfap"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Lxn and Gfap/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p4
```

### Lxn and Mfn2 correlation in astrocytes

```{r calc-hexagon-representation-spearman-lxn-mfn2}
p5 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Lxn", "Mfn2"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Lxn and Mfn2/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p5
```

### Gfap and Mfn2 correlation in astrocytes

```{r calc-hexagon-representation-spearman-gfap-mfn2}
p6 <- plot_hexbin_interact(srt,
  type = c("data", "data"),
  mod = c("RNA", "RNA"), feature = c("Gfap", "Mfn2"), interact = "corr_spearman",
  ylab = "densMAP2", xlab = "densMAP1",
  title = "Interaction between mRNA expression of Gfap and Mfn2/nSpearman rho in hexagonal cells representation"
) +
  scale_fill_gradientn(
    colors = srt@misc$expr_Colour_Palette_gnuplot_r,
    na.value = "white"
  )

p6
```

### Plot in one grid

```{r calc-hexagon-representation-spearman-grid, fig.width=28, fig.height=24}
# Create an empty plot for the unused spaces in the grid
empty <- plot_grid(NULL, NULL, labels = "")

# Arrange the plots
plot_grid(
  p3, empty, empty,
  p2, p6, empty,
  p1, p5, p4,
  ncol = 3, nrow = 3
)
```

## Barplot of Insr and Lxn expression in astrocytes across different individual hypothalamic nuclei

```{r plot-bargraph, fig.width=7, fig.height=6}
# Create a new variable that combines Insr_pos and Lxn_pos
df <- sbs_mtx %>%
  mutate(VarComb = case_when(
    Insr_pos & Lxn_pos ~ "Insr+/Lxn+",
    Insr_pos & !Lxn_pos ~ "Insr+/Lxn-",
    !Insr_pos & Lxn_pos ~ "Insr-/Lxn+",
    !Insr_pos & !Lxn_pos ~ "Insr-/Lxn-"
  ))

# Calculate counts and proportions for each category
df_counts <- df %>%
  group_by(region, VarComb) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n))

# Calculate the total counts for each category
df_total_counts <- df %>%
  group_by(region) %>%
  summarise(total_n = n())

# Create a vector of region names ordered by prop for Insr+/Lxn+ cases for each region
ordered_regions <- df_counts %>%
  filter(VarComb == "Insr+/Lxn-") %>%
  arrange(desc(prop)) %>%
  pull(region)

# Reorder the factor levels of region
df_counts$region <- factor(df_counts$region, levels = ordered_regions)
df_total_counts$region <- factor(df_total_counts$region, levels = ordered_regions)

# Reorder the factor levels of combinations
df_counts$VarComb <- factor(df_counts$VarComb, levels = rev(c("Insr+/Lxn-", "Insr+/Lxn+", "Insr-/Lxn+", "Insr-/Lxn-")))

# Create a stacked bar plot
ggplot(df_counts, aes(x = region, y = n, fill = VarComb)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = c("Insr+/Lxn+" = "purple", "Insr+/Lxn-" = "red3", "Insr-/Lxn+" = "royalblue", "Insr-/Lxn-" = "grey50")) +
  labs(x = "Hypothalamic subregion", y = "Number of cells", fill = "Expression") +
  theme_minimal() +
  scale_x_discrete(labels = coded_region)

ggplot(df_counts, aes(x = region, y = prop, fill = VarComb)) +
  geom_bar(stat = "identity", color = "black", position = "fill") +
  scale_fill_manual(values = c("Insr+/Lxn-" = "red3", "Insr+/Lxn+" = "purple", "Insr-/Lxn+" = "royalblue", "Insr-/Lxn-" = "grey50")) +
  labs(x = "Hypothalamic subregion", y = "Proportion of cells", fill = "Expression") +
  theme_minimal() +
  scale_x_discrete(labels = coded_region)
```

## Session information

```{r session-info, cache = FALSE}
sI <- sessioninfo::session_info()
sI$loadedOnly <- NULL
print(sI, locale = FALSE)
```

